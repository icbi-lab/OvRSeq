#' Plot Vulnerability Map
#'
#' This function creates a vulnerability map based on three key variables: the vulnerability score,
#' the BRCAness score, and the cytolytic activity (CYT) to C1QA ratio (C2C). The BRCAness score is
#' derived from the prediction probability of a random forest classifier. The C2C ratio is calculated
#' using the log2-transformed expression values of GZMB, PRF1, and C1QA.
#'
#' The vulnerability score is defined as a weighted sum of the BRCAness probability and the C2C ratio,
#' where the weights are determined by a logistic regression model. This model uses log2 intensity
#' expression values and SigMA status (mutational signature 3) data from the TOPACIO cohort with the
#' treatment response as a binary dependent variable.
#'
#' The function plots a two-dimensional map with the transformed C2C ratio and BRCAness probability as
#' coordinates. The map is color-coded based on the vulnerability score.
#'
#' @param se A SummarizedExperiment object containing the necessary data for plotting. It must include
#'           BRCAness probabilities and CYT to C1QA ratios, or data to compute them.
#'
#' @return A ggplot object representing the vulnerability map.
#'
#' @details
#' C2C is computed as follows:
#' \deqn{C2C = 0.5 \times (\log_2(GZMB + 1) + \log_2(PRF1 + 1)) / \log_2(C1QA + 1)}
#'
#' The vulnerability score is computed using:
#' \deqn{Vulnerability Score = 2.687 \times BRCAness Probability + 1.051 \times C2C}
#'
#' For visualization, C2C values are transformed to a range between 0 and 1 using a sigmoid function.
#' The BRCAness probability and the transformed C2C values are used as coordinates on the map.
#'
#' @examples
#' # se is a SummarizedExperiment object with required data
#' plot_vulnerabilitymap(se)
#'
#' @export
plot_vulnerabilitymap <- function(se) {
  # Check for required data and compute if necessary
  if (!("BRCAness_Prob" %in% colnames(colData(se)))) {
    #BRCAness probability is computed here and added to colData
    brcaness_classifier <- load_brcaness_classifier()
    brcaness_signature <- load_brcaness_signature()
    se <- classify_brcaness(se, brcaness_classifier, brcaness_signature)
  }
  if (!("ratio_CYT_C1QA" %in% colnames(colData(se)))) {
    #C2C ratio is computed here and added to colData
    se <- computeCytC1qaRatio(se)
  }

  # External functions
  mean_C2C <- 0.3013737
  sd_C2C <- 0.1359056

  mapping <- function(x) {
    v = x
    w = 1/(1+exp(-(pi*(x-(mean_C2C)/(sd_C2C)))))
    return(w)
  }

  # Coefficients for vulnerability score calculation
  coefBRCAness <- 2.596728
  coefRatio <- 1.165859

  # Create matrix for background
  x <- seq(0, 1, length.out = 500)
  y <- seq(0, 1, length.out = 500)
  matrix_result <- outer((x * coefRatio), (y * coefBRCAness), "+")

  # Convert matrix to data frame for ggplot
  matrix_df <- melt(matrix_result)
  names(matrix_df) <- c("x", "y", "value")
  matrix_df$x <- x[matrix_df$x]
  matrix_df$y <- y[matrix_df$y]

  # Extract relevant data for plotting
  data <- colData(se)
  score <- (data$ratio_CYT_C1QA * coefRatio) + (data$BRCAness_Prob * coefBRCAness)
  data_plot_new <- data.frame(x = mapping(data$ratio_CYT_C1QA), y = data$BRCAness_Prob, score = score)

  # Create the plot
  p <- ggplot() +
    geom_raster(data = matrix_df, aes(x = x, y = y, fill = value), interpolate = TRUE) +
    scale_fill_gradientn(colours = colorRampPalette(c("blue", '#eeaa0d', "red"))(1000)) +
    geom_point(data = data_plot_new, aes(x = x, y = y, color = score), size = 2) +
    scale_colour_gradientn(colours = c("blue", '#FFDD20', "red")) +
    ggtitle("Vulnerability Map") +
    theme_minimal() + coord_fixed(ratio = 1) +
    xlab("C2C Ratio") +
    ylab("BRCAness Probability")

return(p)

}
